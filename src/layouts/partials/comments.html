<div id="comments-widget" class="max-w-2xl mx-auto mt-10">
  <h2 class="text-lg font-medium mb-4 text-gray-900 dark:text-gray-100">Comments</h2>

  <form id="commentForm" class="space-y-2 bg-white dark:bg-gray-900 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
    <input type="hidden" id="siteId" value="{{ .Site.BaseURL }}">
    <input type="hidden" id="postSlug" value="{{ .File.BaseFileName }}">

    <div class="grid grid-cols-2 gap-2">
      <input id="author" class="px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm placeholder-gray-500 dark:placeholder-gray-400" placeholder="Name" required>
      <input id="email" type="email" class="px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm placeholder-gray-500 dark:placeholder-gray-400" placeholder="Email" required>
    </div>

    <textarea id="content" rows="4" class="w-full px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm placeholder-gray-500 dark:placeholder-gray-400" placeholder="Write a comment..." required></textarea>

    <input type="hidden" id="turnstileToken" value="">

    <!-- Cloudflare Turnstile widget -->
    <div
      class="cf-turnstile"
      data-sitekey="0x4AAAAAAABCp0ljCLkn6iFC"
      data-callback="onTurnstileSuccess"
    ></div>

    <div class="flex items-center gap-2">
      <button type="button" id="emojiBtn" class="px-3 py-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm hover:bg-gray-200 dark:hover:bg-gray-600">ðŸ˜€</button>
      <button type="submit" id="submitBtn" class="px-4 py-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm hover:bg-gray-200 dark:hover:bg-gray-600">Post comment</button>
      <span id="status" class="text-xs text-gray-500 dark:text-gray-400"></span>
    </div>
    <div id="emojiPicker" style="display: none; position: absolute; bottom: 50px; left: 0; z-index: 50;"></div>
  </form>

  <div id="comments" class="mt-6 space-y-3"></div>
</div>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script>
  import { Picker } from 'emoji-mart';

  const API_BASE = "{{ .Site.Params.commentsBackend }}";
  const el = (id) => document.getElementById(id);

  window.onTurnstileSuccess = function (token) {
    el("turnstileToken").value = token;
    clearError("captcha");
  };

  function escapeHTML(s) {
    if (!s) return '';
    return s.replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;');
  }

  function timeAgo(iso) {
    const d = new Date(iso);
    const diff = Math.floor((Date.now() - d.getTime()) / 1000);
    if (diff < 60) return diff + 's';
    if (diff < 3600) return Math.floor(diff/60) + 'm';
    if (diff < 86400) return Math.floor(diff/3600) + 'h';
    return Math.floor(diff/86400) + 'd';
  }

  function showNotification(message, type = 'info', container = el('status')) {
    const colors = {
      success: 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800',
      error: 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border-red-200 dark:border-red-800',
      warning: 'bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300 border-yellow-200 dark:border-yellow-800',
      info: 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-800'
    };

    container.innerHTML = `
      <div class="p-3 rounded-md border ${colors[type] || colors.info}">
        ${escapeHTML(message)}
      </div>
    `;

    if (type !== 'error') {
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
  }

  function clearError(field = null) {
    if (field) {
      const input = el(field);
      if (input) input.classList.remove('border-red-500', 'dark:border-red-500');
    }
    el('status').innerHTML = '';
  }

  function showFieldError(fieldId, message) {
    const input = el(fieldId);
    if (input) {
      input.classList.add('border-red-500', 'dark:border-red-500');
    }
    showNotification(message, 'error');
  }

  function createCommentNode(comment) {
    const container = document.createElement('article');
    container.className = 'p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600';
    container.dataset.id = comment.id;
    container.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="flex-1">
          <div class="flex items-baseline justify-between">
            <div class="text-sm font-medium text-gray-900 dark:text-gray-100">${escapeHTML(comment.author)} <span class="text-xs text-gray-400 dark:text-gray-500">Â· ${timeAgo(comment.created_at)}</span></div>
            <div>
              <button data-reply class="text-xs px-2 py-1 rounded text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">reply</button>
            </div>
          </div>
          <p class="mt-2 text-sm whitespace-pre-wrap text-gray-900 dark:text-gray-100">${escapeHTML(comment.content)}</p>
          <div class="mt-3 space-y-2" data-replies></div>
        </div>
      </div>`;
    return container;
  }

  function insertComment(comment, prepend = true) {
    const node = createCommentNode(comment);
    if (comment.parent_id) {
      const parent = el('comments').querySelector(`[data-id="${comment.parent_id}"]`);
      if (parent) {
        const replies = parent.querySelector('[data-replies]');
        if (prepend) replies.prepend(node); else replies.append(node);
        return;
      }
    }
    if (prepend) el('comments').prepend(node); else el('comments').append(node);
  }

  function renderCommentThread(comment) {
    insertComment(comment, false);
    if (comment.replies && comment.replies.length) {
      comment.replies.forEach(r => renderCommentThread(r));
    }
  }

  async function fetchComments() {
    const siteId = el('siteId').value;
    const postSlug = el('postSlug').value;
    try {
      const res = await fetch(
        `${API_BASE}/comments?site_id=${encodeURIComponent(siteId)}&post_slug=${encodeURIComponent(postSlug)}`,
        { headers: { 'accept': 'application/json' } }
      );
      if (!res.ok) throw new Error(await res.text() || res.statusText);
      const comments = await res.json();
      el('comments').innerHTML = '';
      comments.forEach(c => renderCommentThread(c));
    } catch (err) {
      console.error('Failed to load comments:', err);
      showNotification('Failed to load comments', 'error', el('comments'));
    }
  }

  function openReplyForm(parentNode, parentId) {
    if (parentNode.querySelector('[data-reply-form]')) return;
    const form = document.createElement('form');
    form.dataset.replyForm = '1';
    form.className = 'mt-3 p-2 bg-gray-50 dark:bg-gray-900 rounded';
    form.innerHTML = `
      <textarea name="content" rows="3" class="w-full px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-sm placeholder-gray-500 dark:placeholder-gray-400" placeholder="Reply..."></textarea>
      <div class="mt-2 flex gap-2">
        <input name="author" placeholder="Name" class="px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-sm placeholder-gray-500 dark:placeholder-gray-400" required />
        <input name="email" placeholder="Email" class="px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-sm placeholder-gray-500 dark:placeholder-gray-400" required />
        <button class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm hover:bg-gray-200 dark:hover:bg-gray-600">Reply</button>
        <button type="button" class="px-3 py-1 rounded text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-cancel>Cancel</button>
      </div>
      <div class="mt-2 text-xs" data-reply-status></div>`;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const replyStatus = form.querySelector('[data-reply-status]');
      
      const author = form.author.value.trim();
      const email = form.email.value.trim();
      const content = form.content.value.trim();

      if (!author) {
        replyStatus.innerHTML = '<div class="p-2 rounded-md bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800">Name is required</div>';
        return;
      }
      if (!email) {
        replyStatus.innerHTML = '<div class="p-2 rounded-md bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800">Email is required</div>';
        return;
      }
      if (!content) {
        replyStatus.innerHTML = '<div class="p-2 rounded-md bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800">Comment cannot be empty</div>';
        return;
      }

      const payload = {
        site_id: el('siteId').value,
        post_slug: el('postSlug').value,
        author,
        email,
        content,
        parent_id: parentId,
        turnstile_token: el('turnstileToken').value || ''
      };
      
      await postComment(payload, {
        onSuccess: (saved) => {
          insertComment(saved, true);
          form.remove();
          if (window.turnstile && window.turnstile.reset) window.turnstile.reset();
        },
        statusElement: replyStatus
      });
    });
    
    form.querySelector('[data-cancel]').addEventListener('click', () => form.remove());
    parentNode.querySelector('[data-replies]').prepend(form);
    form.querySelector('textarea').focus();
  }

  async function postComment(payload, opts = {}) {
    const statusElement = opts.statusElement || el('status');
    const submitBtn = el('submitBtn');
    
    try {
      if (submitBtn) submitBtn.disabled = true;
      
      if (!payload.turnstile_token) {
        showNotification('Please complete the CAPTCHA', 'error', statusElement);
        return null;
      }

      showNotification('Posting...', 'info', statusElement);

      const res = await fetch(`${API_BASE}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => null);

      if (!res.ok) {
        let errorMessage = 'Failed to post comment';
        
        if (data?.detail) {
          if (typeof data.detail === 'string') {
            errorMessage = data.detail;
          } else if (Array.isArray(data.detail)) {
            errorMessage = data.detail[0]?.msg || errorMessage;
          }
        } else if (res.status === 422) {
          errorMessage = 'Invalid input. Please check your information.';
        } else if (res.status === 429) {
          errorMessage = 'Too many requests. Please wait a moment.';
        } else if (res.status === 401) {
          errorMessage = 'CAPTCHA verification failed. Please try again.';
        } else if (res.status >= 500) {
          errorMessage = 'Server error. Please try again later.';
        }
        
        showNotification(errorMessage, 'error', statusElement);
        return null;
      }

      const saved = data;
      showNotification('Comment posted! Awaiting approval.', 'success', statusElement);
      
      if (opts.onSuccess) opts.onSuccess(saved);
      if (!payload.parent_id) {
        el('content').value = '';
        el('author').value = '';
        el('email').value = '';
      }
      if (window.turnstile && window.turnstile.reset) window.turnstile.reset();
      
      return saved;
    } catch (err) {
      console.error('Post comment failed', err);
      showNotification('Network error. Please try again.', 'error', statusElement);
      return null;
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-reply]');
    if (btn) {
      const article = btn.closest('article');
      const id = article?.dataset?.id;
      if (id) openReplyForm(article, Number(id));
    }
  });

  el('commentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();
    
    const author = el('author').value.trim();
    const email = el('email').value.trim();
    const content = el('content').value.trim();

    if (!author) {
      showFieldError('author', 'Name is required');
      return;
    }
    if (!email) {
      showFieldError('email', 'Email is required');
      return;
    }
    if (!content) {
      showFieldError('content', 'Comment cannot be empty');
      return;
    }

    const payload = {
      site_id: el('siteId').value,
      post_slug: el('postSlug').value,
      author,
      email,
      content,
      parent_id: null,
      turnstile_token: el('turnstileToken').value || ''
    };
    
    await postComment(payload, { 
      onSuccess: (saved) => insertComment(saved, true)
    });
  });

  // fetch existing comments on page load
  document.addEventListener('DOMContentLoaded', fetchComments);

  // emoji picker
  document.getElementById('emojiBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const picker = document.getElementById('emojiPicker');
    
    if (picker.firstChild) {
      picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
      return;
    }

    new Picker({
      data: async () => {
        const response = await fetch(
          'https://cdn.jsdelivr.net/npm/@emoji-mart/data',
        )
        return response.json()
      },
      onEmojiSelect: (emoji) => {
        const textarea = el('content');
        textarea.value += emoji.native;
        textarea.focus();
        document.getElementById('emojiPicker').style.display = 'none';
      },
      theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
    }).mount(picker);

    picker.style.display = 'block';
  });
</script>
